dist: xenial

language: minimal

addons:
  apt:
    packages:
      - python3
      - python3-pip

install:
# thank you https://stackoverflow.com/a/47441734
# this is requried to be able to checkout branches after fetching
- git config remote.origin.fetch +refs/heads/*:refs/remotes/origin/*
- git fetch origin deployment
- pip3 install --user jinja2;

script:
# TODO: move this to external script
- git submodule update --init
- src/generate/generate-message.py --output-dir src/message
- g++ test/test-message.cpp -std=c++11
- ./a.out || travis_terminate 1
# because these files are gitignored, we have to force-add and commit them
# in order to move them to the deployment branch. every other approach I tried
# clobbered the files
- git add src/message -f
- git commit -m temporary-commit
- git checkout deployment
- git checkout HEAD@{1} src/message
- git diff --staged
- git commit -m "update autogenerated files" || travis_terminate 0
- git remote set-url origin https://${GITHUB_TOKEN}@github.com/bluerobotics/ping-cpp
- git push origin
